var requestMedia=function(c){this.defaults={feed_in:null,feed_out:null,request_video:true,request_audio:true,name:["file_",(new Date()+"").slice(4,28),".mp4"].join(""),required_audio:true,required_video:true,file_type:"video/mp4",onGetPermission:function(){},onForgetPermission:function(){},onDeniedPermission:function(d){console.log(d.name+": "+d.message);
},onStartRecording:function(){},onStopRecording:function(){},onPictureTaken:function(){},onDownload:function(){}};for(var b in this.defaults){this[b]=(c[b]!==undefined)?c[b]:this.defaults[b];
}this.data_array=[];this.stream=null;this.recorder=null;this.blob=null;this.browser=navigator.userAgent;this.canvas=null;};requestMedia.prototype.getFeed_in=function(){return this.feed_in;
};requestMedia.prototype.getFeed_out=function(){return this.feed_out;};requestMedia.prototype.getRequest_video=function(){return this.request_video;};requestMedia.prototype.getRequest_audio=function(){return this.request_audio;
};requestMedia.prototype.getName=function(){return this.name;};requestMedia.prototype.getFile_type=function(){return this.file_type;};requestMedia.prototype.getOnGetPermission=function(){return this.onGetPermission;
};requestMedia.prototype.getOnForgetPermission=function(){return this.onForgetPermission;};requestMedia.prototype.getOnDeniedPermission=function(){return this.onDeniedPermission;
};requestMedia.prototype.getOnStartRecording=function(){return this.onStartRecording;};requestMedia.prototype.getOnStopRecording=function(){return this.onStopRecording;
};requestMedia.prototype.getOnPictureTaken=function(){return this.onPictureTaken;};requestMedia.prototype.getOnDownload=function(){return this.onDownload;
};requestMedia.prototype.getData_array=function(){return this.data_array;};requestMedia.prototype.getStream=function(){return this.stream;};requestMedia.prototype.getRecorder=function(){return this.recorder;
};requestMedia.prototype.getBlob=function(){return this.blob;};requestMedia.prototype.getRequired_audio=function(){return this.required_audio;};requestMedia.prototype.getRequired_video=function(){return this.required_video;
};requestMedia.prototype.getCanvas=function(){return this.canvas;};requestMedia.prototype.setCanvas=function(b){this.canvas=b;};requestMedia.prototype.forgetPermission=function(){if(this.stream==null){return;
}for(var b=0;b<this.stream.getTracks().length;b++){this.stream.getTracks()[b].stop();}if(this.onForgetPermission&&typeof this.onForgetPermission==="function"){this.onForgetPermission();
}};requestMedia.prototype.requestPermission=function(){var b=this;navigator.mediaDevices.getUserMedia({video:b.request_video,audio:b.request_audio}).then(function(c){b.stream=c;
if(b.stream.getVideoTracks().length==0&&b.required_video){b.onDeniedPermission({name:"Required Video",message:"No video device found."});b.forgetPermission();
}else{if(b.stream.getAudioTracks().length==0&&b.required_audio){b.onDeniedPermission({name:"Required Audio",message:"No audio device found."});b.forgetPermission();
}else{if(b.feed_in){b.feed_in.setAttribute("src",URL.createObjectURL(b.stream));}if(b.onGetPermission&&typeof b.onGetPermission==="function"){b.onGetPermission();
}}}}).then(null,b.onDeniedPermission&&typeof b.onDeniedPermission==="function"?b.onDeniedPermission:function(c){console.log(c.name+": "+c.message);});};
requestMedia.prototype.startRecording=function(){var b=this;if(this.browser.indexOf("Chrome")>-1){if(b.onStartRecording&&typeof b.onStartRecording==="function"){b.onStartRecording();
}b.recorder=new MediaRecorder(b.stream);b.recorder.ondataavailable=function(c){b.data_array.push(c.data);};b.recorder.start();}else{if(b.browser.indexOf("Firefox")>-1||b.browser.indexOf("Opera")>-1){if(b.onStartRecording&&typeof b.onStartRecording==="function"){b.onStartRecording();
}b.recorder=new MediaRecorder(b.stream);b.recorder.start();}else{if(b.onStartRecording&&typeof b.onStartRecording==="function"){b.onStartRecording();}b.recorder=new MediaRecorder(b.stream);
b.recorder.start();b.recorder.ondataavailable=function(c){b.data_array.push(c.data);};}}};requestMedia.prototype.stopRecording=function(){var b=this;if(b.browser.indexOf("Chrome")>-1){b.promise=new Promise(function(c){b.recorder.stop();
b.interval=setInterval(function(){if(b.data_array.length>0){clearInterval(b.interval);c(b.data_array);}},2000);});b.promise.then(function(c){b.blob=new Blob(c,{type:b.file_type});
b.urlobj=URL.createObjectURL(b.blob);if(b.feed_out){b.feed_out.setAttribute("src",URL.createObjectURL(b.blob));}if(b.onStopRecording&&typeof b.onStopRecording==="function"){setTimeout(b.onStopRecording(),50);
}b.data_array=[];});}else{if(b.browser.indexOf("Firefox")>-1||b.browser.indexOf("Opera")>-1){b.recorder.ondataavailable=function(c){b.urlobj=URL.createObjectURL(c.data);
b.blob=new Blob([c.data],{type:b.file_type});if(b.feed_out){b.feed_out.setAttribute("src",URL.createObjectURL(c.data));}if(b.onStopRecording&&typeof b.onStopRecording==="function"){setTimeout(b.onStopRecording(),50);
}};b.recorder.stop();}else{b.recorder.stop();b.blob=new Blob(b.data_array,{type:b.file_type});b.urlobj=URL.createObjectURL(b.blob);if(b.feed_out){b.feed_out.setAttribute("src",URL.createObjectURL(b.blob));
}if(b.onStopRecording&&typeof b.onStopRecording==="function"){setTimeout(b.onStopRecording(),50);}b.data_array=[];}}};requestMedia.prototype.startCanvas=function(c){var f=this;
var e=c,b=0,d=null;if(f.getCanvas()){b=f.feed_in.videoHeight/(f.feed_in.videoWidth/e);if(isNaN(b)){b=e*9/12;}f.canvas.setAttribute("width",e);f.canvas.setAttribute("height",b);
}d=f.canvas.getContext("2d");d.fillStyle="#AAA";d.fillRect(0,0,f.canvas.width,f.canvas.height);var g=f.canvas.toDataURL("image/png");f.feed_out.setAttribute("src",g);
};requestMedia.prototype.takePicture=function(){var j=this;var b=j.canvas.getContext("2d");if(j.canvas.width&&j.canvas.height){width=j.canvas.width;height=j.canvas.height;
b.drawImage(j.feed_in,0,0,width,height);var c=j.canvas.toDataURL("image/png");j.feed_out.setAttribute("src",c);j.urlobj=c;var f=";base64,";var g=c.split(f);
var k=g[0].split(":")[1];var e=window.atob(g[1]);var l=e.length;var d=new Uint8Array(l);for(var h=0;h<l;++h){d[h]=e.charCodeAt(h);}j.blob=new Blob([d],{type:k});
if(j.onPictureTaken&&typeof j.onPictureTaken==="function"){setTimeout(j.onPictureTaken(),50);}}else{console.log("erro");console.log(j.canvas);}};requestMedia.prototype.download=function(){var b=this;
if(b.onDownload&&typeof b.onDownload==="function"){b.onDownload();}a=document.createElement("a");a.style="display: none";a.download=b.name;a.href=b.urlobj;
a.textContent=a.download;document.body.appendChild(a);a.click();setTimeout(function(){document.body.removeChild(a);URL.revokeObjectURL(a.href);},200);};
